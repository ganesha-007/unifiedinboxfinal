version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: whatsapp-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: ["redis-server", "--save", "", "--appendonly", "no"]
  postgres:
    image: postgres:15-alpine
    container_name: whatsapp-postgres
    environment:
      POSTGRES_DB: whatsapp_integration
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: whatsapp-backend
    environment:
      PORT: 3001
      NODE_ENV: production
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: whatsapp_integration
      DB_USER: postgres
      DB_PASSWORD: postgres
      UNIPILE_API_KEY: ${UNIPILE_API_KEY:-your_unipile_api_key_here}
      UNIPILE_API_URL: ${UNIPILE_API_URL:-https://api14.unipile.com:14429/api/v1}
      JWT_SECRET: your_jwt_secret_here_change_this
      CORS_ORIGIN: http://localhost:3000
      PRICING_MODE: bundled
      # Gmail OAuth Configuration
      GOOGLE_CLIENT_ID: your_google_client_id
      GOOGLE_CLIENT_SECRET: your_google_client_secret
      GOOGLE_REDIRECT_URI: http://localhost:3001/api/auth/gmail/callback
      # Google Cloud Pub/Sub Configuration
      GOOGLE_CLOUD_PROJECT_ID: project-2-for-service
      GOOGLE_CLOUD_KEY_FILE: /app/keys/service-account.json
      # Frontend URL (for OAuth redirects)
      FRONTEND_URL: http://localhost:3000
      # Email Rate Limiting Configuration
      EMAIL_MAX_RECIPIENTS_PER_MESSAGE: 10
      EMAIL_MAX_PER_HOUR: 50
      EMAIL_MAX_PER_DAY: 200
      EMAIL_PER_RECIPIENT_COOLDOWN_SEC: 120
      EMAIL_PER_DOMAIN_COOLDOWN_SEC: 60
      EMAIL_MAX_ATTACHMENT_BYTES: 10485760
      EMAIL_TRIAL_DAILY_CAP: 20
      # Monthly Usage Limits Configuration
      WHATSAPP_MONTHLY_LIMIT: 5000
      INSTAGRAM_MONTHLY_LIMIT: 5000
      EMAIL_MONTHLY_LIMIT: 10000
      OUTLOOK_MONTHLY_LIMIT: 10000
      # Webhook Security Configuration
      UNIPILE_WEBHOOK_SECRET: your_webhook_secret_here_change_this
      # Redis Configuration
      REDIS_URL: redis://redis:6379
      REDIS_DB: 0
      REDIS_TLS: "false"
      # BullMQ Configuration
      EMAIL_QUEUE_CONCURRENCY: 5
      BULLMQ_PREFIX: "whatsapp_app"
      # Monitoring Configuration
      SENTRY_DSN: ${SENTRY_DSN:-}
      SENTRY_TRACES_SAMPLE_RATE: ${SENTRY_TRACES_SAMPLE_RATE:-0.1}
      SENTRY_PROFILES_SAMPLE_RATE: ${SENTRY_PROFILES_SAMPLE_RATE:-0.1}
      APP_VERSION: ${APP_VERSION:-1.0.0}
      APP_ENV: ${APP_ENV:-development}
      # Stripe Billing Configuration
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      CHECKOUT_SUCCESS_URL: ${CHECKOUT_SUCCESS_URL:-http://localhost:3000/billing/success}
      CHECKOUT_CANCEL_URL: ${CHECKOUT_CANCEL_URL:-http://localhost:3000/billing/cancel}
      PORTAL_RETURN_URL: ${PORTAL_RETURN_URL:-http://localhost:3000/settings/billing}
      STARTER_MONTHLY_PRICE_ID: ${STARTER_MONTHLY_PRICE_ID}
      GROWTH_MONTHLY_PRICE_ID: ${GROWTH_MONTHLY_PRICE_ID}
      SCALE_MONTHLY_PRICE_ID: ${SCALE_MONTHLY_PRICE_ID}
      ADDON_WHATSAPP_MONTHLY_PRICE_ID: ${ADDON_WHATSAPP_MONTHLY_PRICE_ID}
      ADDON_INSTAGRAM_MONTHLY_PRICE_ID: ${ADDON_INSTAGRAM_MONTHLY_PRICE_ID}
      ADDON_EMAIL_MONTHLY_PRICE_ID: ${ADDON_EMAIL_MONTHLY_PRICE_ID}
      # Microsoft Graph Configuration
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID:-your_microsoft_client_id}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET:-your_microsoft_client_secret}
      MICROSOFT_REDIRECT_URI: ${MICROSOFT_REDIRECT_URI:-http://localhost:3001/api/auth/outlook/callback}
      # Graph Webhook Configuration
      GRAPH_WEBHOOK_BASE_URL: ${GRAPH_WEBHOOK_BASE_URL:-https://your-domain.com}
      GRAPH_NOTIFICATION_QUEUE_CONCURRENCY: ${GRAPH_NOTIFICATION_QUEUE_CONCURRENCY:-5}
    ports:
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - /app/node_modules

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: whatsapp-frontend
    environment:
      REACT_APP_API_URL: http://localhost:3001/api
      # Monitoring Configuration
      REACT_APP_SENTRY_DSN: ${REACT_APP_SENTRY_DSN:-}
      REACT_APP_SENTRY_TRACES_SAMPLE_RATE: ${REACT_APP_SENTRY_TRACES_SAMPLE_RATE:-0.1}
      REACT_APP_VERSION: ${APP_VERSION:-1.0.0}
    ports:
      - "3000:3000"
    depends_on:
      - backend

volumes:
  postgres_data:
  redis_data:

